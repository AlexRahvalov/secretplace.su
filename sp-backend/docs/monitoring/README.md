# Документация по мониторингу Minecraft серверов

## Содержание
1. [Общая информация](#общая-информация)
2. [Компоненты системы мониторинга](#компоненты-системы-мониторинга)
3. [API эндпоинты](#api-эндпоинты)
4. [Обработка ошибок](#обработка-ошибок)
5. [Адаптивные интервалы проверки](#адаптивные-интервалы-проверки)

## Общая информация

Система мониторинга Minecraft серверов предназначена для автоматического отслеживания статуса серверов и обновления информации о них в базе данных. Система использует библиотеки `minecraft-server-util` и `minecraft-protocol` для взаимодействия с серверами Minecraft и получения информации о их статусе.

Основные возможности системы:
- Проверка доступности серверов
- Получение информации о версии сервера
- Подсчет онлайн игроков
- Измерение задержки (пинга)
- Адаптивные интервалы проверки
- Обработка и классификация ошибок
- Рекомендации по устранению проблем

## Компоненты системы мониторинга

### MinecraftPinger

Класс `MinecraftPinger` предоставляет функциональность для пинга серверов Minecraft и получения их статуса. Он инкапсулирует логику подключения к серверу и обработки полученной информации.

```typescript
// Пример использования
const serverStatus = await MinecraftPinger.pingServer('play.example.com', 25565);
console.log(`Статус: ${serverStatus.online ? 'онлайн' : 'оффлайн'}`);
console.log(`Игроки: ${serverStatus.onlinePlayers}/${serverStatus.maxPlayers}`);
```

### ServerMonitor

Класс `ServerMonitor` управляет мониторингом всех серверов. Он реализует паттерн Singleton и выполняет следующие функции:
- Запуск и остановка мониторинга серверов
- Управление интервалами проверки
- Обновление информации в базе данных
- Обработка ошибок и адаптация интервалов

```typescript
// Пример использования
const monitor = ServerMonitor.getInstance();
await monitor.startMonitoring();

// Остановка мониторинга
monitor.stopMonitoring();
```

### MonitoringDatabaseUpdater

Класс `MonitoringDatabaseUpdater` отвечает за обновление схемы базы данных для поддержки мониторинга. Он добавляет необходимые поля в таблицу `servers` при первом запуске.

## API эндпоинты

Система мониторинга предоставляет следующие API эндпоинты:

### Получение статуса всех серверов
```
GET /api/servers/status
```

Пример ответа:
```json
{
  "status": "success",
  "data": [
    {
      "id": 1,
      "name": "SurvivalServer",
      "ip": "play.example.com",
      "port": 25565,
      "status": "online",
      "online_players": 42,
      "max_players": 100,
      "version": "1.20.2",
      "motd": "Welcome to our Minecraft server!",
      "latency": 23,
      "last_ping": "2025-04-05T10:15:30Z",
      "last_online": "2025-04-05T10:15:30Z"
    },
    // ...другие серверы
  ]
}
```

### Получение статуса конкретного сервера
```
GET /api/servers/:id/status
```

Пример ответа:
```json
{
  "status": "success",
  "data": {
    "id": 1,
    "name": "SurvivalServer",
    "ip": "play.example.com",
    "port": 25565,
    "status": "online",
    "online_players": 42,
    "max_players": 100,
    "version": "1.20.2",
    "motd": "Welcome to our Minecraft server!",
    "latency": 23,
    "last_ping": "2025-04-05T10:15:30Z",
    "last_online": "2025-04-05T10:15:30Z"
  }
}
```

### Получение информации о серверах с ошибками
```
GET /api/servers/errors
```

Пример ответа:
```json
{
  "status": "success",
  "data": [
    {
      "id": 2,
      "name": "CreativeServer",
      "ip": "creative.example.com",
      "port": 25565,
      "status": "offline",
      "errorType": "CONNECTION_REFUSED",
      "secondsOffline": 3600,
      "lastPing": "2025-04-05T08:15:30Z",
      "troubleshootingTips": "Проверьте, что сервер запущен и порт открыт. Возможно, брандмауэр блокирует подключение."
    },
    // ...другие серверы с ошибками
  ]
}
```

## Обработка ошибок

Система мониторинга включает в себя комплексный механизм обработки ошибок, реализованный в классе `MonitoringErrorHandler`. Он классифицирует ошибки по типам и предоставляет рекомендации по их устранению.

### Типы ошибок

- `CONNECTION_REFUSED` - Подключение отклонено сервером
- `CONNECTION_TIMEOUT` - Превышено время ожидания подключения
- `CONNECTION_RESET` - Соединение сброшено сервером
- `UNKNOWN_HOST` - Не удалось найти хост
- `INVALID_RESPONSE` - Некорректный ответ от сервера
- `SERVER_OFFLINE` - Сервер не в сети
- `DATABASE_ERROR` - Ошибка базы данных
- `UNKNOWN_ERROR` - Неизвестная ошибка

### Рекомендации по устранению проблем

Для каждого типа ошибки система предоставляет рекомендации по устранению проблемы. Например:

- Для `CONNECTION_REFUSED`: "Проверьте, что сервер запущен и порт открыт. Возможно, брандмауэр блокирует подключение."
- Для `CONNECTION_TIMEOUT`: "Проверьте сетевое подключение. Возможно, сервер перегружен или сеть нестабильна."

```typescript
// Пример использования обработчика ошибок
try {
  // Код, который может вызвать ошибку
} catch (error) {
  const monitoringError = MonitoringErrorHandler.handleError(error, {
    id: 1,
    name: "Server1",
    ip: "play.example.com",
    port: 25565
  });
  
  const tips = MonitoringErrorHandler.getTroubleshootingTips(monitoringError);
  console.log(`Рекомендации: ${tips}`);
}
```

## Адаптивные интервалы проверки

Система мониторинга использует адаптивные интервалы проверки для оптимизации нагрузки:

- **30 секунд** для серверов в статусе **онлайн**
- **60 секунд** для серверов в статусе **оффлайн**
- **5 минут** для серверов после **5 последовательных ошибок**

Это позволяет снизить нагрузку на недоступные серверы и быстрее реагировать на изменения статуса доступных серверов. 